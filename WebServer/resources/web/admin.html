<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - äºŒæ‰‹æˆ¿ä¿¡æ¯å¹³å°</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>ğŸ  äºŒæ‰‹æˆ¿å¹³å° - ç®¡ç†åå°</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">è¿”å›é¦–é¡µ</a>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="username"></span>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="admin-section">
            <h2>ğŸ”§ ç®¡ç†åå°</h2>
            
            <div id="loadingIndicator" class="loading">åŠ è½½ä¸­...</div>
            
            <div id="adminContent" style="display: none;">
                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ˜ï¸</div>
                        <div class="stat-value" id="totalHouses">0</div>
                        <div class="stat-label">æˆ¿æºæ€»æ•°</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">â­</div>
                        <div class="stat-value" id="totalFavorites">0</div>
                        <div class="stat-label">æ”¶è—æ€»æ•°</div>
                    </div>
                </div>
                
                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <div class="admin-card">
                    <h3>ç”¨æˆ·ç®¡ç†</h3>
                    <div id="usersList" class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>é‚®ç®±</th>
                                    <th>ç±»å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>æœ€åç™»å½•</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="unauthorizedMessage" style="display: none; text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ”’</div>
                <h3>æƒé™ä¸è¶³</h3>
                <p>æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢</p>
                <button class="btn btn-primary" onclick="window.location.href='/'">è¿”å›é¦–é¡µ</button>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 äºŒæ‰‹æˆ¿ä¿¡æ¯å¹³å°. All rights reserved.</p>
        </div>
    </footer>

    <style>
        .admin-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-section h2 {
            color: #dc3545;
            margin-bottom: 2rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .admin-card {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .admin-card h3 {
            color: #dc3545;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dc3545;
        }
        
        .users-table {
            overflow-x: auto;
        }
        
        .users-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .users-table th {
            background: #dc3545;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .users-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .user-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .user-badge.admin {
            background: #dc3545;
            color: white;
        }
        
        .user-badge.user {
            background: #667eea;
            color: white;
        }
    </style>

    <script src="/js/common.js"></script>
    <script>
        // åŠ è½½ç®¡ç†å‘˜æ•°æ®
        async function loadAdminData() {
            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
            if (!currentUser || !currentUser.isAdmin) {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('unauthorizedMessage').style.display = 'block';
                return;
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            // å¹¶è¡ŒåŠ è½½ç”¨æˆ·ç»Ÿè®¡å’Œç”¨æˆ·åˆ—è¡¨
            const [statsData, usersData] = await Promise.all([
                apiRequest('/api/admin/stats'),
                apiRequest('/api/admin/users')
            ]);
            
            document.getElementById('loadingIndicator').style.display = 'none';
            
            if (statsData.success && statsData.data) {
                displayStats(statsData.data);
            }
            
            if (usersData.success && usersData.data) {
                displayUsers(usersData.data);
            }
            
            document.getElementById('adminContent').style.display = 'block';
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
        function displayStats(stats) {
            document.getElementById('totalUsers').textContent = formatNumber(stats.totalUsers || 0);
            document.getElementById('totalHouses').textContent = formatNumber(stats.totalHouses || 0);
            document.getElementById('totalFavorites').textContent = formatNumber(stats.totalFavorites || 0);
        }
        
        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                const isDisabled = user.is_disabled || false;
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email || '-'}</td>
                    <td>
                        <span class="user-badge ${user.is_admin ? 'admin' : 'user'}">
                            ${user.is_admin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}
                        </span>
                    </td>
                    <td>
                        <span class="user-badge ${isDisabled ? 'disabled' : 'active'}">
                            ${isDisabled ? 'å·²ç¦ç”¨' : 'æ­£å¸¸'}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${user.last_login ? formatDate(user.last_login) : 'ä»æœªç™»å½•'}</td>
                    <td>
                        ${user.is_admin ? '<span style="color: #999;">ç®¡ç†å‘˜</span>' : `
                            <button class="btn btn-sm ${isDisabled ? 'btn-success' : 'btn-danger'}" 
                                    onclick="toggleUserStatus(${user.id}, ${!isDisabled})">
                                ${isDisabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </button>
                        `}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(userId, disabled) {
            if (!confirm(`ç¡®å®šè¦${disabled ? 'ç¦ç”¨' : 'å¯ç”¨'}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }
            
            const data = await apiRequest('/api/admin/toggle-user', {
                method: 'POST',
                body: JSON.stringify({ userId, disabled })
            });
            
            if (data.success) {
                showMessage(data.message, 'success');
                // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                const usersData = await apiRequest('/api/admin/users');
                if (usersData.success) {
                    displayUsers(usersData.data);
                }
            } else {
                showMessage(data.message, 'error');
            }
        }
                // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(userId, disabled) {
            if (!confirm(`ç¡®å®šè¦${disabled ? 'ç¦ç”¨' : 'å¯ç”¨'}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }
            
            const data = await apiRequest('/api/admin/toggle-user', {
                method: 'POST',
                body: JSON.stringify({ userId, disabled })
            });
            
            if (data.success) {
                showMessage(data.message, 'success');
                const usersData = await apiRequest('/api/admin/users');
                if (usersData.success) {
                    displayUsers(usersData.data);
                }
            } else {
                showMessage(data.message, 'error');
            }
        }
                // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿ common.js å·²ç»åŠ è½½å®Œ localStorage
            setTimeout(() => {
                if (currentUser) {
                    document.getElementById('username').textContent = currentUser.username + ' (ç®¡ç†å‘˜)';
                }
                loadAdminData();
            }, 100);
        });
    </script>
</body>
</html>

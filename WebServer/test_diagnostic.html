<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†ç ä¿®æ”¹åŠŸèƒ½è¯Šæ–­</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .diagnostic-section {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .log-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-info { color: #9cdcfe; }
        .log-warn { color: #dcdcaa; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background: #4caf50; }
        .status-fail { background: #f44336; }
        .status-pending { background: #ff9800; }
        .check-item {
            padding: 10px;
            margin: 10px 0;
            background: #f5f5f5;
            border-left: 4px solid #2196F3;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="diagnostic-section">
        <h1>ğŸ” å¯†ç ä¿®æ”¹åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤é¡µé¢ç”¨äºè¯Šæ–­å¯†ç ä¿®æ”¹åŠŸèƒ½çš„é—®é¢˜</p>

        <h2>æ­¥éª¤ 1ï¼šç¯å¢ƒæ£€æŸ¥</h2>
        <div id="envChecks"></div>
        <button class="btn btn-primary" onclick="runEnvironmentChecks()">è¿è¡Œç¯å¢ƒæ£€æŸ¥</button>

        <h2>æ­¥éª¤ 2ï¼šæ¶ˆæ¯æç¤ºæµ‹è¯•</h2>
        <div class="btn-group" style="display: flex; gap: 10px; margin: 10px 0;">
            <button class="btn btn-primary" onclick="testMessage('success', 'æˆåŠŸæ¶ˆæ¯æµ‹è¯•')">æµ‹è¯•æˆåŠŸæ¶ˆæ¯</button>
            <button class="btn btn-secondary" onclick="testMessage('error', 'é”™è¯¯æ¶ˆæ¯æµ‹è¯•')">æµ‹è¯•é”™è¯¯æ¶ˆæ¯</button>
            <button class="btn" onclick="testMessage('info', 'ä¿¡æ¯æ¶ˆæ¯æµ‹è¯•')">æµ‹è¯•ä¿¡æ¯æ¶ˆæ¯</button>
        </div>

        <h2>æ­¥éª¤ 3ï¼šè¡¨å•æäº¤æµ‹è¯•</h2>
        <div class="test-form">
            <form id="testPasswordForm">
                <div class="form-group">
                    <label>å½“å‰å¯†ç ï¼ˆæ¨¡æ‹Ÿï¼‰</label>
                    <input type="password" id="testOldPassword" name="oldPassword" placeholder="è¾“å…¥ä»»æ„å¯†ç ">
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="testNewPassword" name="newPassword" minlength="6" placeholder="è‡³å°‘6ä½">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="testConfirmPassword" name="confirmPassword" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary">æµ‹è¯•æäº¤</button>
            </form>
        </div>

        <h2>æ­¥éª¤ 4ï¼šAPI æµ‹è¯•</h2>
        <button class="btn btn-primary" onclick="testAPI()">æµ‹è¯• API è¿æ¥</button>

        <h2>ğŸ“‹ è¯Šæ–­æ—¥å¿—</h2>
        <button class="btn btn-secondary btn-sm" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div class="log-output" id="logOutput"></div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        const logOutput = document.getElementById('logOutput');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLog() {
            logOutput.innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // ç¯å¢ƒæ£€æŸ¥
        function runEnvironmentChecks() {
            const checksDiv = document.getElementById('envChecks');
            checksDiv.innerHTML = '';
            
            addLog('å¼€å§‹ç¯å¢ƒæ£€æŸ¥...', 'info');
            
            const checks = [
                {
                    name: 'showMessage å‡½æ•°',
                    test: () => typeof showMessage === 'function',
                    fix: 'common.js æœªæ­£ç¡®åŠ è½½'
                },
                {
                    name: 'apiRequest å‡½æ•°',
                    test: () => typeof apiRequest === 'function',
                    fix: 'common.js æœªæ­£ç¡®åŠ è½½'
                },
                {
                    name: 'currentUser å˜é‡',
                    test: () => typeof currentUser !== 'undefined',
                    fix: 'common.js åˆå§‹åŒ–å¤±è´¥'
                },
                {
                    name: 'localStorage å¯ç”¨',
                    test: () => typeof localStorage !== 'undefined',
                    fix: 'æµè§ˆå™¨ä¸æ”¯æŒ localStorage'
                },
                {
                    name: 'CSS åŠ¨ç”»æ”¯æŒ',
                    test: () => {
                        const el = document.createElement('div');
                        return 'animation' in el.style;
                    },
                    fix: 'æµè§ˆå™¨ä¸æ”¯æŒ CSS åŠ¨ç”»'
                }
            ];

            checks.forEach(check => {
                const result = check.test();
                const checkItem = document.createElement('div');
                checkItem.className = 'check-item';
                checkItem.innerHTML = `
                    <span class="status-indicator status-${result ? 'pass' : 'fail'}"></span>
                    <strong>${check.name}</strong>: ${result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                    ${result ? '' : '<br><small style="color: #f44336;">è§£å†³æ–¹æ³•: ' + check.fix + '</small>'}
                `;
                checksDiv.appendChild(checkItem);
                
                addLog(`${check.name}: ${result ? 'é€šè¿‡' : 'å¤±è´¥'}`, result ? 'success' : 'error');
            });

            addLog('ç¯å¢ƒæ£€æŸ¥å®Œæˆ', 'success');
        }

        // æµ‹è¯•æ¶ˆæ¯
        function testMessage(type, message) {
            addLog(`æ˜¾ç¤º${type}æ¶ˆæ¯: ${message}`, 'info');
            try {
                showMessage(message, type);
                addLog(`æ¶ˆæ¯æ˜¾ç¤ºæˆåŠŸ`, 'success');
            } catch (error) {
                addLog(`æ¶ˆæ¯æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è¡¨å•æäº¤
        document.getElementById('testPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addLog('è¡¨å•æäº¤äº‹ä»¶è§¦å‘', 'info');
            
            const formData = new FormData(this);
            const oldPassword = formData.get('oldPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            addLog(`æ—§å¯†ç : ${oldPassword ? '***' : '(ç©º)'}`, 'info');
            addLog(`æ–°å¯†ç : ${newPassword ? '***' : '(ç©º)'}`, 'info');
            addLog(`ç¡®è®¤å¯†ç : ${confirmPassword ? '***' : '(ç©º)'}`, 'info');
            
            if (!oldPassword || oldPassword.trim() === '') {
                addLog('éªŒè¯å¤±è´¥: æ—§å¯†ç ä¸ºç©º', 'error');
                testMessage('error', 'è¯·è¾“å…¥å½“å‰å¯†ç ');
                return;
            }
            
            if (!newPassword || newPassword.length < 6) {
                addLog('éªŒè¯å¤±è´¥: æ–°å¯†ç é•¿åº¦ä¸è¶³', 'error');
                testMessage('error', 'æ–°å¯†ç è‡³å°‘éœ€è¦6ä½');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                addLog('éªŒè¯å¤±è´¥: ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
                testMessage('error', 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            addLog('è¡¨å•éªŒè¯é€šè¿‡', 'success');
            
            // æ¨¡æ‹ŸAPIè¯·æ±‚
            const requestData = {
                userId: currentUser ? currentUser.userId : 0,
                oldPassword: oldPassword,
                newPassword: newPassword,
                useEmailVerify: false
            };
            
            addLog(`æ¨¡æ‹ŸAPIè¯·æ±‚: ${JSON.stringify(requestData)}`, 'info');
            testMessage('success', 'è¡¨å•éªŒè¯é€šè¿‡ï¼å¯ä»¥å‘é€è¯·æ±‚');
        });

        // æµ‹è¯•API
        async function testAPI() {
            addLog('æµ‹è¯•APIè¿æ¥...', 'info');
            
            if (typeof apiRequest !== 'function') {
                addLog('é”™è¯¯: apiRequest å‡½æ•°ä¸å­˜åœ¨', 'error');
                return;
            }
            
            try {
                // æµ‹è¯•ä¸€ä¸ªå…¬å¼€çš„APIç«¯ç‚¹
                addLog('å‘é€æµ‹è¯•è¯·æ±‚åˆ° /api/houses', 'info');
                const data = await apiRequest('/api/houses', {
                    method: 'GET'
                });
                
                addLog(`APIå“åº”: ${JSON.stringify(data).substring(0, 100)}...`, 'success');
                testMessage('success', 'APIè¿æ¥æ­£å¸¸');
            } catch (error) {
                addLog(`APIè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                testMessage('error', 'APIè¿æ¥å¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            addLog('='.repeat(50), 'info');
            addLog('è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
            addLog('æµè§ˆå™¨: ' + navigator.userAgent, 'info');
            addLog('å½“å‰ç”¨æˆ·: ' + (currentUser ? currentUser.username : 'æœªç™»å½•'), 'info');
            addLog('='.repeat(50), 'info');
        });
    </script>
</body>
</html>

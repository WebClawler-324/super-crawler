<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ”¶è— - äºŒæ‰‹æˆ¿ä¿¡æ¯å¹³å°</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>ğŸ  äºŒæ‰‹æˆ¿å¹³å°</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">é¦–é¡µ</a>
                <a href="/favorites.html" class="nav-link active">æˆ‘çš„æ”¶è—</a>
                <a href="/statistics.html" class="nav-link">æ•°æ®ç»Ÿè®¡</a>
                <a href="/ai-assistant.html" class="nav-link">AIåŠ©æ‰‹</a>
            </div>
            <div class="nav-user">
                <div class="user-info" id="userInfo">
                    <span id="username"></span>
                    <button class="btn btn-secondary btn-sm" onclick="window.location.href='/settings.html'">è®¾ç½®</button>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="favorites-section">
            <h2>â­ æˆ‘çš„æ”¶è—</h2>
            
            <div id="loadingIndicator" class="loading">åŠ è½½ä¸­...</div>
            
            <div id="favoritesList" class="houses-grid">
                <!-- æ”¶è—çš„æˆ¿æºå°†åŠ¨æ€æ’å…¥ -->
            </div>
            
            <div id="emptyMessage" style="display: none; text-align: center; padding: 3rem; color: #999;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“­</div>
                <p style="font-size: 1.2rem;">è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æˆ¿æº</p>
                <button class="btn btn-primary" onclick="window.location.href='/'">å»çœ‹çœ‹</button>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 äºŒæ‰‹æˆ¿ä¿¡æ¯å¹³å°. All rights reserved.</p>
        </div>
    </footer>

    <style>
        .favorites-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .favorites-section h2 {
            color: #667eea;
            margin-bottom: 2rem;
        }
    </style>

    <script src="/js/common.js"></script>
    <script>
        // åŠ è½½æ”¶è—åˆ—è¡¨
        async function loadFavorites() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/';
                return;
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            const data = await apiRequest(`/api/favorites?userId=${currentUser.userId}`);
            
            document.getElementById('loadingIndicator').style.display = 'none';
            
            if (data.success && data.data) {
                const favorites = data.data;
                displayFavorites(favorites);
            } else {
                showMessage(data.message || 'åŠ è½½å¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºæ”¶è—åˆ—è¡¨
        function displayFavorites(favorites) {
            const favoritesList = document.getElementById('favoritesList');
            const emptyMessage = document.getElementById('emptyMessage');
            
            if (favorites.length === 0) {
                favoritesList.style.display = 'none';
                emptyMessage.style.display = 'block';
                return;
            }
            
            favoritesList.innerHTML = '';
            favorites.forEach(house => {
                const card = createHouseCard(house);
                favoritesList.appendChild(card);
            });
        }
        
        // åˆ›å»ºæˆ¿æºå¡ç‰‡
        function createHouseCard(house) {
            const card = document.createElement('div');
            card.className = 'house-card';
            card.innerHTML = `
                <div class="house-image">ğŸ </div>
                <div class="house-content">
                    <h3 class="house-title">${house.houseTitle || 'æœªå‘½åæˆ¿äº§'}</h3>
                    <div class="house-info">
                        <div class="house-info-item">
                            <span>å°åŒºï¼š</span>
                            <span>${house.communityName || '-'}</span>
                        </div>
                        <div class="house-info-item">
                            <span>æˆ·å‹ï¼š</span>
                            <span>${house.houseType || '-'}</span>
                        </div>
                        <div class="house-info-item">
                            <span>é¢ç§¯ï¼š</span>
                            <span>${house.area || '-'} ã¡</span>
                        </div>
                        <div class="house-info-item">
                            <span>æ¥¼å±‚ï¼š</span>
                            <span>${house.floor || '-'}</span>
                        </div>
                    </div>
                    <div class="house-price">
                        Â¥ ${formatNumber(house.price)} ä¸‡
                        <div class="house-unit-price">å•ä»·: ${formatNumber(house.unitPrice)} å…ƒ/ã¡</div>
                    </div>
                    <div class="house-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewHouseDetail(${house.ID})">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-danger btn-sm" onclick="removeFavorite(${house.ID}, this)">å–æ¶ˆæ”¶è—</button>
                    </div>
                </div>
            `;
            return card;
        }
        
        // æŸ¥çœ‹æˆ¿æºè¯¦æƒ…
        function viewHouseDetail(houseId) {
            window.location.href = `/house-detail.html?id=${houseId}`;
        }
        
        // å–æ¶ˆæ”¶è—
        async function removeFavorite(houseId, button) {
            if (!confirm('ç¡®å®šå–æ¶ˆæ”¶è—å—ï¼Ÿ')) {
                return;
            }
            
            const data = await apiRequest('/api/favorites', {
                method: 'DELETE',
                body: JSON.stringify({
                    userId: currentUser.userId,
                    houseId: houseId
                })
            });
            
            if (data.success) {
                showMessage('å·²å–æ¶ˆæ”¶è—', 'success');
                loadFavorites(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else {
                showMessage(data.message, 'error');
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (currentUser) {
                document.getElementById('username').textContent = currentUser.username;
            }
            loadFavorites();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†ç éªŒè¯æµ‹è¯•å·¥å…·</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .result-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }
        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .hash-display {
            background: #1e1e1e;
            color: #4ec9b0;
            padding: 10px;
            border-radius: 3px;
            word-break: break-all;
            font-size: 14px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” å¯†ç éªŒè¯æµ‹è¯•å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•å¯†ç å“ˆå¸Œå’ŒéªŒè¯é€»è¾‘</p>

        <!-- æ­¥éª¤1ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ -->
        <div class="test-section">
            <h2>æ­¥éª¤1ï¼šæ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€</h2>
            <div id="loginStatus"></div>
            <button class="btn btn-primary" onclick="checkLoginStatus()">æ£€æŸ¥çŠ¶æ€</button>
        </div>

        <!-- æ­¥éª¤2ï¼šæµ‹è¯•ç™»å½• -->
        <div class="test-section">
            <h2>æ­¥éª¤2ï¼šæµ‹è¯•ç™»å½•ï¼ˆéªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®ï¼‰</h2>
            <form id="testLoginForm" onsubmit="testLogin(event)">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="testUsername" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="testPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">æµ‹è¯•ç™»å½•</button>
            </form>
            <div id="loginResult"></div>
        </div>

        <!-- æ­¥éª¤3ï¼šæµ‹è¯•å¯†ç ä¿®æ”¹ -->
        <div class="test-section">
            <h2>æ­¥éª¤3ï¼šæµ‹è¯•å¯†ç ä¿®æ”¹API</h2>
            <p><small>æ­¤æµ‹è¯•ä¼šå°è¯•ä¿®æ”¹å¯†ç ï¼Œä½†ä¼šç«‹å³æ”¹å›ï¼Œç¡®ä¿ä¸å½±å“å®é™…ä½¿ç”¨</small></p>
            <form id="testChangePasswordForm" onsubmit="testChangePassword(event)">
                <div class="form-group">
                    <label>å½“å‰å¯†ç ï¼ˆä¸æ­¥éª¤2ç›¸åŒï¼‰</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç ï¼ˆæµ‹è¯•ç”¨ï¼‰</label>
                    <input type="password" id="newPassword" value="test123456" required>
                </div>
                <button type="submit" class="btn btn-primary">æµ‹è¯•ä¿®æ”¹</button>
            </form>
            <div id="changePasswordResult"></div>
        </div>

        <!-- æ­¥éª¤4ï¼šæŸ¥çœ‹è¯¦ç»†æ—¥å¿— -->
        <div class="test-section">
            <h2>ğŸ“‹ è¯¦ç»†æ—¥å¿—</h2>
            <div id="detailedLog" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;"></div>
            <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="test-section">
            <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugInfo"></div>
            <button class="btn btn-secondary" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        const logDiv = document.getElementById('detailedLog');

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#4ec9b0' : type === 'error' ? '#f48771' : '#9cdcfe';
            const log = document.createElement('div');
            log.innerHTML = `<span style="color: #6a9955;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
            logDiv.appendChild(log);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function clearLog() {
            logDiv.innerHTML = '';
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            addLog('æ£€æŸ¥ç™»å½•çŠ¶æ€...', 'info');
            const statusDiv = document.getElementById('loginStatus');
            
            if (currentUser) {
                statusDiv.innerHTML = `
                    <div class="result-box result-success">
                        <strong>âœ… å·²ç™»å½•</strong><br>
                        ç”¨æˆ·ID: ${currentUser.userId}<br>
                        ç”¨æˆ·å: ${currentUser.username}<br>
                        é‚®ç®±: ${currentUser.email || 'æœªç»‘å®š'}<br>
                        æ˜¯å¦ç®¡ç†å‘˜: ${currentUser.isAdmin ? 'æ˜¯' : 'å¦'}
                    </div>
                `;
                addLog(`å½“å‰ç”¨æˆ·: ${currentUser.username} (ID: ${currentUser.userId})`, 'success');
            } else {
                statusDiv.innerHTML = `
                    <div class="result-box result-error">
                        <strong>âŒ æœªç™»å½•</strong><br>
                        è¯·å…ˆåœ¨é¦–é¡µç™»å½•åå†è¿›è¡Œæµ‹è¯•
                    </div>
                `;
                addLog('æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·', 'error');
            }
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin(event) {
            event.preventDefault();
            addLog('='.repeat(50), 'info');
            addLog('å¼€å§‹æµ‹è¯•ç™»å½•...', 'info');
            
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            const resultDiv = document.getElementById('loginResult');
            
            addLog(`ç”¨æˆ·å: ${username}`, 'info');
            addLog(`å¯†ç : ${'*'.repeat(password.length)}`, 'info');
            
            resultDiv.innerHTML = '<div class="result-box result-info">æ­£åœ¨éªŒè¯...</div>';
            
            try {
                const data = await apiRequest('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                addLog(`æœåŠ¡å™¨å“åº”: ${JSON.stringify(data)}`, 'info');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result-box result-success">
                            <strong>âœ… ç™»å½•æˆåŠŸ</strong><br>
                            è¿™è¡¨æ˜æ‚¨çš„å¯†ç æ˜¯æ­£ç¡®çš„ï¼<br>
                            ç”¨æˆ·ID: ${data.data.userId}<br>
                            Tokenå·²è·å–
                        </div>
                    `;
                    addLog('ç™»å½•éªŒè¯æˆåŠŸï¼å¯†ç æ­£ç¡®ï¼', 'success');
                    
                    // æ›´æ–°å½“å‰ç”¨æˆ·
                    currentUser = data.data;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // è‡ªåŠ¨å¡«å……å½“å‰å¯†ç åˆ°ä¿®æ”¹å¯†ç è¡¨å•
                    document.getElementById('currentPassword').value = password;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result-box result-error">
                            <strong>âŒ ç™»å½•å¤±è´¥</strong><br>
                            ${data.message}<br>
                            <small>è¿™è¡¨æ˜ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®</small>
                        </div>
                    `;
                    addLog(`ç™»å½•å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result-box result-error">
                        <strong>âŒ è¯·æ±‚å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
                addLog(`è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å¯†ç ä¿®æ”¹
        async function testChangePassword(event) {
            event.preventDefault();
            addLog('='.repeat(50), 'info');
            addLog('å¼€å§‹æµ‹è¯•å¯†ç ä¿®æ”¹...', 'info');
            
            if (!currentUser || !currentUser.userId) {
                addLog('é”™è¯¯: æœªç™»å½•', 'error');
                document.getElementById('changePasswordResult').innerHTML = `
                    <div class="result-box result-error">
                        <strong>âŒ æœªç™»å½•</strong><br>
                        è¯·å…ˆåœ¨æ­¥éª¤2ä¸­æˆåŠŸç™»å½•
                    </div>
                `;
                return;
            }
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const resultDiv = document.getElementById('changePasswordResult');
            
            addLog(`å½“å‰ç”¨æˆ·ID: ${currentUser.userId}`, 'info');
            addLog(`å½“å‰å¯†ç : ${'*'.repeat(currentPassword.length)}`, 'info');
            addLog(`æ–°å¯†ç : ${'*'.repeat(newPassword.length)}`, 'info');
            
            const requestData = {
                userId: currentUser.userId,
                oldPassword: currentPassword,
                newPassword: newPassword,
                useEmailVerify: false
            };
            
            addLog(`è¯·æ±‚æ•°æ®: ${JSON.stringify({...requestData, oldPassword: '***', newPassword: '***'})}`, 'info');
            
            resultDiv.innerHTML = '<div class="result-box result-info">æ­£åœ¨å‘é€è¯·æ±‚...</div>';
            
            try {
                const data = await apiRequest('/api/change-password', {
                    method: 'POST',
                    body: JSON.stringify(requestData)
                });
                
                addLog(`æœåŠ¡å™¨å“åº”: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result-box result-success">
                            <strong>âœ… å¯†ç ä¿®æ”¹è¯·æ±‚æˆåŠŸ</strong><br>
                            ${data.message}<br>
                            <small>æ³¨æ„: å®é™…ç¯å¢ƒä¸­å¯†ç å·²æ”¹å˜ï¼Œè¯·åŠæ—¶æ”¹å›ï¼</small>
                        </div>
                    `;
                    addLog('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="result-box result-error">
                            <strong>âŒ å¯†ç ä¿®æ”¹å¤±è´¥</strong><br>
                            æœåŠ¡å™¨è¿”å›: ${data.message}<br>
                            <br>
                            <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
                            1. æ—§å¯†ç ä¸æ­£ç¡®ï¼ˆä½†æ­¥éª¤2ç™»å½•æˆåŠŸï¼Œè¯´æ˜å¯†ç åº”è¯¥æ˜¯å¯¹çš„ï¼‰<br>
                            2. å¯†ç å“ˆå¸Œç®—æ³•ä¸ä¸€è‡´<br>
                            3. æ•°æ®åº“ä¸­çš„å¯†ç å“ˆå¸Œæ ¼å¼å¼‚å¸¸<br>
                            <br>
                            <small>è¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯</small>
                        </div>
                    `;
                    addLog(`å¯†ç ä¿®æ”¹å¤±è´¥: ${data.message}`, 'error');
                    addLog('âš ï¸ è¿™å¾ˆå¯èƒ½æ˜¯åç«¯å¯†ç éªŒè¯é€»è¾‘çš„é—®é¢˜', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result-box result-error">
                        <strong>âŒ è¯·æ±‚å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
                addLog(`è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        async function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            
            let html = '<div class="result-box result-info">';
            html += '<strong>æµè§ˆå™¨ä¿¡æ¯:</strong><br>';
            html += `User Agent: ${navigator.userAgent}<br><br>`;
            
            html += '<strong>å½“å‰ç”¨æˆ·ä¿¡æ¯:</strong><br>';
            if (currentUser) {
                html += `<pre>${JSON.stringify(currentUser, null, 2)}</pre>`;
            } else {
                html += 'æœªç™»å½•<br>';
            }
            
            html += '<br><strong>LocalStorage:</strong><br>';
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                html += `<pre>${JSON.stringify(JSON.parse(storedUser), null, 2)}</pre>`;
            } else {
                html += 'æ— å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯<br>';
            }
            
            html += '<br><strong>API Base URL:</strong><br>';
            html += `${API_BASE}<br>`;
            
            html += '<br><strong>ç¯å¢ƒæ£€æŸ¥:</strong><br>';
            html += `showMessage å‡½æ•°: ${typeof showMessage === 'function' ? 'âœ…' : 'âŒ'}<br>`;
            html += `apiRequest å‡½æ•°: ${typeof apiRequest === 'function' ? 'âœ…' : 'âŒ'}<br>`;
            
            html += '</div>';
            
            debugDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            addLog('å¯†ç éªŒè¯æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            checkLoginStatus();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API è°ƒè¯•å·¥å…· - äºŒæ‰‹æˆ¿å¹³å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #667eea; margin-bottom: 20px; }
        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.9; }
        .result {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }
        .status { padding: 5px 10px; border-radius: 3px; display: inline-block; margin-bottom: 10px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #eee; }
        .log-entry.error { color: #dc3545; }
        .log-entry.success { color: #28a745; }
        .log-entry.info { color: #17a2b8; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ API è°ƒè¯•å·¥å…·</h1>
        
        <!-- æ•°æ®åº“è¿æ¥æ£€æŸ¥ -->
        <div class="section">
            <h2>1. æ•°æ®åº“è¿æ¥æ£€æŸ¥</h2>
            <button class="btn btn-primary" onclick="checkDatabase()">æ£€æŸ¥æ•°æ®åº“</button>
            <div id="dbResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- çƒ­é—¨æˆ¿æº API æµ‹è¯• -->
        <div class="section">
            <h2>2. çƒ­é—¨æˆ¿æº API æµ‹è¯• (/api/houses/popular)</h2>
            <button class="btn btn-primary" onclick="testPopularHouses()">æµ‹è¯• API</button>
            <button class="btn btn-success" onclick="testPopularHousesRaw()">æŸ¥çœ‹åŸå§‹å“åº”</button>
            <div id="popularResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- æˆ¿æºåˆ—è¡¨ API æµ‹è¯• -->
        <div class="section">
            <h2>3. æˆ¿æºåˆ—è¡¨ API æµ‹è¯• (/api/houses)</h2>
            <button class="btn btn-primary" onclick="testHousesList()">æµ‹è¯• API</button>
            <div id="housesResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- æ”¶è—æ•°æ®æ£€æŸ¥ -->
        <div class="section">
            <h2>4. æ”¶è—æ•°æ®æ£€æŸ¥ (/api/debug/favorites)</h2>
            <button class="btn btn-primary" onclick="testFavorites()">æ£€æŸ¥æ”¶è—æ•°æ®</button>
            <div id="favoritesResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- ç»Ÿè®¡ API æµ‹è¯• -->
        <div class="section">
            <h2>5. ç»Ÿè®¡ API æµ‹è¯• (/api/houses/statistics)</h2>
            <button class="btn btn-primary" onclick="testStatistics()">æµ‹è¯• API</button>
            <div id="statsResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- ç”¨æˆ·ç¦ç”¨åŠŸèƒ½æµ‹è¯• -->
        <div class="section">
            <h2>6. ç”¨æˆ·ç¦ç”¨åŠŸèƒ½æµ‹è¯•</h2>
            <div class="input-group">
                <label>æµ‹è¯•ç”¨æˆ·å</label>
                <input type="text" id="testUsername" placeholder="è¾“å…¥è¦æµ‹è¯•çš„ç”¨æˆ·å">
            </div>
            <div class="input-group">
                <label>æµ‹è¯•å¯†ç </label>
                <input type="password" id="testPassword" placeholder="è¾“å…¥å¯†ç ">
            </div>
            <button class="btn btn-primary" onclick="testDisabledLogin()">æµ‹è¯•ç¦ç”¨ç”¨æˆ·ç™»å½•</button>
            <div id="disabledLoginResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- ç™¾åº¦åœ°å›¾é…ç½®æµ‹è¯• -->
        <div class="section">
            <h2>7. ç™¾åº¦åœ°å›¾é…ç½®æµ‹è¯•</h2>
            <button class="btn btn-primary" onclick="testBaiduMapConfig()">æµ‹è¯•åœ°å›¾é…ç½®</button>
            <button class="btn btn-success" onclick="testBaiduMapLoad()">æµ‹è¯•åœ°å›¾åŠ è½½</button>
            <button class="btn btn-secondary" onclick="testHouseDetailPage()" style="background:#6c757d;color:white;">æµ‹è¯•æˆ¿æºè¯¦æƒ…é¡µ</button>
            <div id="baiduMapResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- å®Œæ•´è¯Šæ–­ -->
        <div class="section">
            <h2>8. å®Œæ•´è¯Šæ–­æŠ¥å‘Š</h2>
            <button class="btn btn-danger" onclick="runFullDiagnosis()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <div id="diagnosisResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h2>
            <button class="btn btn-secondary" onclick="clearLogs()" style="background:#6c757d;color:white;">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logs" class="result" style="display:block; min-height: 200px;"></div>
        </div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function fetchAPI(url, options = {}) {
            log(`è¯·æ±‚: ${options.method || 'GET'} ${url}`);
            const startTime = Date.now();
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                const elapsed = Date.now() - startTime;
                log(`å“åº”: ${response.status} ${response.statusText} (${elapsed}ms)`, response.ok ? 'success' : 'error');
                
                const text = await response.text();
                try {
                    return { success: true, data: JSON.parse(text), raw: text, status: response.status };
                } catch (e) {
                    return { success: true, data: null, raw: text, status: response.status, parseError: e.message };
                }
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        function showResult(elementId, content) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.innerHTML = content;
        }
        
        async function checkDatabase() {
            log('æ£€æŸ¥æ•°æ®åº“è¿æ¥...');
            const result = await fetchAPI('/api/houses?limit=1');
            let html = '';
            if (result.success && result.data && result.data.success) {
                html = `<div class="status success">âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸</div>`;
                html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                log('æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
            } else {
                html = `<div class="status error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥</div>`;
                html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                log('æ•°æ®åº“è¿æ¥å¤±è´¥', 'error');
            }
            showResult('dbResult', html);
        }
        
        async function testPopularHouses() {
            log('æµ‹è¯•çƒ­é—¨æˆ¿æº API...');
            const result = await fetchAPI('/api/houses/popular');
            let html = '';
            
            if (result.success) {
                if (result.data && result.data.success) {
                    const houses = result.data.data || [];
                    html = `<div class="status success">âœ… API è°ƒç”¨æˆåŠŸ</div>`;
                    html += `<p><strong>è¿”å›æˆ¿æºæ•°é‡:</strong> ${houses.length}</p>`;
                    
                    if (houses.length > 0) {
                        html += `<table>
                            <tr><th>#</th><th>ID</th><th>æ ‡é¢˜</th><th>å°åŒº</th><th>æ”¶è—æ•°</th><th>ä»·æ ¼</th></tr>`;
                        houses.forEach((h, i) => {
                            html += `<tr>
                                <td>${i+1}</td>
                                <td>${h.ID || h.id || '-'}</td>
                                <td>${h.houseTitle || '-'}</td>
                                <td>${h.communityName || '-'}</td>
                                <td>${h.favorite_count || 0}</td>
                                <td>${h.price || '-'}ä¸‡</td>
                            </tr>`;
                        });
                        html += `</table>`;
                        log(`æˆåŠŸè·å– ${houses.length} æ¡çƒ­é—¨æˆ¿æº`, 'success');
                    } else {
                        html += `<div class="status error">âš ï¸ è¿”å›æ•°æ®ä¸ºç©ºæ•°ç»„</div>`;
                        log('è¿”å›æ•°æ®ä¸ºç©º', 'error');
                    }
                } else {
                    html = `<div class="status error">âŒ API è¿”å›å¤±è´¥</div>`;
                    html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    log('API è¿”å›å¤±è´¥: ' + (result.data?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } else {
                html = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${result.error}</div>`;
            }
            
            showResult('popularResult', html);
        }
        
        async function testPopularHousesRaw() {
            log('è·å–çƒ­é—¨æˆ¿æºåŸå§‹å“åº”...');
            const result = await fetchAPI('/api/houses/popular');
            let html = `<div class="status ${result.success ? 'success' : 'error'}">
                HTTP ${result.status || 'N/A'}
            </div>`;
            html += `<p><strong>åŸå§‹å“åº”:</strong></p>`;
            html += `<pre>${result.raw || result.error || 'æ— æ•°æ®'}</pre>`;
            
            if (result.parseError) {
                html += `<div class="status error">JSON è§£æé”™è¯¯: ${result.parseError}</div>`;
            }
            
            showResult('popularResult', html);
        }
        
        async function testHousesList() {
            log('æµ‹è¯•æˆ¿æºåˆ—è¡¨ API...');
            const result = await fetchAPI('/api/houses?limit=5');
            let html = '';
            
            if (result.success && result.data && result.data.success) {
                const houses = result.data.data || [];
                html = `<div class="status success">âœ… API è°ƒç”¨æˆåŠŸ</div>`;
                html += `<p><strong>è¿”å›æˆ¿æºæ•°é‡:</strong> ${houses.length}</p>`;
                
                if (houses.length > 0) {
                    html += `<p><strong>ç¬¬ä¸€æ¡æ•°æ®å­—æ®µ:</strong></p>`;
                    html += `<pre>${JSON.stringify(Object.keys(houses[0]), null, 2)}</pre>`;
                    html += `<p><strong>ç¬¬ä¸€æ¡æ•°æ®å†…å®¹:</strong></p>`;
                    html += `<pre>${JSON.stringify(houses[0], null, 2)}</pre>`;
                    log(`æˆåŠŸè·å– ${houses.length} æ¡æˆ¿æº`, 'success');
                }
            } else {
                html = `<div class="status error">âŒ API è°ƒç”¨å¤±è´¥</div>`;
                html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
            
            showResult('housesResult', html);
        }
        
        async function testFavorites() {
            log('æ£€æŸ¥æ”¶è—æ•°æ®...');
            const result = await fetchAPI('/api/debug/favorites');
            let html = '';
            
            if (result.success && result.data) {
                html = `<div class="status success">âœ… è°ƒè¯•æ¥å£å“åº”</div>`;
                html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                html = `<div class="status error">âŒ è°ƒè¯•æ¥å£ä¸å¯ç”¨ (å¯èƒ½éœ€è¦æ·»åŠ )</div>`;
                html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                log('è°ƒè¯•æ¥å£ä¸å¯ç”¨', 'error');
            }
            
            showResult('favoritesResult', html);
        }
        
        async function testStatistics() {
            log('æµ‹è¯•ç»Ÿè®¡ API...');
            const result = await fetchAPI('/api/houses/statistics');
            let html = '';
            
            if (result.success && result.data) {
                html = `<div class="status success">âœ… API è°ƒç”¨æˆåŠŸ</div>`;
                html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                log('ç»Ÿè®¡ API æ­£å¸¸', 'success');
            } else {
                html = `<div class="status error">âŒ API è°ƒç”¨å¤±è´¥</div>`;
                html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
            
            showResult('statsResult', html);
        }
        
        async function testDisabledLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            if (!username || !password) {
                showResult('disabledLoginResult', '<div class="status error">è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç </div>');
                return;
            }
            
            log(`æµ‹è¯•ç”¨æˆ· ${username} ç™»å½•...`);
            
            const result = await fetchAPI('/api/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            
            let html = '';
            if (result.success && result.data) {
                if (result.data.success) {
                    html = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥ï¼šç¦ç”¨ç”¨æˆ·ä»ç„¶èƒ½ç™»å½•ï¼</div>`;
                    html += `<p>ç™»å½•æˆåŠŸï¼Œä½†ç”¨æˆ·åº”è¯¥è¢«ç¦ç”¨ã€‚è¯·æ£€æŸ¥ï¼š</p>`;
                    html += `<ul>
                        <li>ç”¨æˆ·æ˜¯å¦ç¡®å®è¢«ç¦ç”¨ (is_disabled = 1)</li>
                        <li>æœåŠ¡å™¨ä»£ç æ˜¯å¦å·²æ›´æ–°</li>
                        <li>getUserByUsername æ˜¯å¦è¿”å› is_disabled å­—æ®µ</li>
                    </ul>`;
                    html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    log('ç¦ç”¨ç”¨æˆ·ä»èƒ½ç™»å½• - æµ‹è¯•å¤±è´¥', 'error');
                } else {
                    const message = result.data.message || '';
                    if (message.includes('ç¦ç”¨') || message.includes('disabled')) {
                        html = `<div class="status success">âœ… æµ‹è¯•æˆåŠŸï¼šç¦ç”¨ç”¨æˆ·æ— æ³•ç™»å½•</div>`;
                        html += `<p>é”™è¯¯æ¶ˆæ¯: ${message}</p>`;
                        log('ç¦ç”¨ç”¨æˆ·æ­£ç¡®æ‹¦æˆª - æµ‹è¯•æˆåŠŸ', 'success');
                    } else if (message.includes('å¯†ç é”™è¯¯') || message.includes('ç”¨æˆ·å')) {
                        html = `<div class="status pending">âš ï¸ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</div>`;
                        html += `<p>æ— æ³•æµ‹è¯•ç¦ç”¨åŠŸèƒ½ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç </p>`;
                        log('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                    } else {
                        html = `<div class="status pending">â“ æœªçŸ¥ç™»å½•å¤±è´¥åŸå› </div>`;
                        html += `<p>æ¶ˆæ¯: ${message}</p>`;
                    }
                }
                html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
            } else {
                html = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${result.error}</div>`;
            }
            
            showResult('disabledLoginResult', html);
        }
        
        async function testBaiduMapConfig() {
            log('æµ‹è¯•ç™¾åº¦åœ°å›¾é…ç½®...');
            const result = await fetchAPI('/api/config');
            let html = '';
            
            if (result.success && result.data) {
                if (result.data.success && result.data.data && result.data.data.baidu_map) {
                    const apiKey = result.data.data.baidu_map.api_key;
                    html = `<div class="status success">âœ… ç™¾åº¦åœ°å›¾é…ç½®æ­£å¸¸</div>`;
                    html += `<p><strong>API Key:</strong> ${apiKey ? apiKey.substring(0, 10) + '...' : 'æœªé…ç½®'}</p>`;
                    if (!apiKey || apiKey === 'YOUR_BAIDU_MAP_AK') {
                        html += `<div class="status error">âš ï¸ è­¦å‘Š: API Key æœªæ­£ç¡®é…ç½®</div>`;
                        html += `<p>è¯·åœ¨ config/config.json ä¸­é…ç½®çœŸå®çš„ç™¾åº¦åœ°å›¾ API Key</p>`;
                    }
                    html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    log('ç™¾åº¦åœ°å›¾é…ç½®è·å–æˆåŠŸ', 'success');
                } else {
                    html = `<div class="status error">âŒ ç™¾åº¦åœ°å›¾é…ç½®ç¼ºå¤±</div>`;
                    html += `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    log('ç™¾åº¦åœ°å›¾é…ç½®ç¼ºå¤±', 'error');
                }
            } else {
                html = `<div class="status error">âŒ è·å–é…ç½®å¤±è´¥: ${result.error}</div>`;
            }
            
            showResult('baiduMapResult', html);
        }
        
        async function testBaiduMapLoad() {
            log('æµ‹è¯•ç™¾åº¦åœ°å›¾APIåŠ è½½...');
            let html = '';
            
            try {
                // è·å–é…ç½®
                const configResult = await fetchAPI('/api/config');
                if (!configResult.success || !configResult.data?.success) {
                    html = `<div class="status error">âŒ æ— æ³•è·å–é…ç½®</div>`;
                    showResult('baiduMapResult', html);
                    return;
                }
                
                const apiKey = configResult.data.data?.baidu_map?.api_key;
                if (!apiKey) {
                    html = `<div class="status error">âŒ API Key æœªé…ç½®</div>`;
                    showResult('baiduMapResult', html);
                    return;
                }
                
                html = `<div class="status pending">â³ æ­£åœ¨åŠ è½½ç™¾åº¦åœ°å›¾API...</div>`;
                html += `<p>API Key: ${apiKey.substring(0, 10)}...</p>`;
                showResult('baiduMapResult', html);
                
                // åŠ¨æ€åŠ è½½ç™¾åº¦åœ°å›¾è„šæœ¬
                const script = document.createElement('script');
                script.src = `https://api.map.baidu.com/api?v=3.0&ak=${apiKey}`;
                
                script.onload = () => {
                    html = `<div class="status success">âœ… ç™¾åº¦åœ°å›¾APIåŠ è½½æˆåŠŸ</div>`;
                    html += `<p>BMapå¯¹è±¡: ${typeof BMap !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰'}</p>`;
                    html += `<p>å¯ä»¥åœ¨æˆ¿æºè¯¦æƒ…é¡µæ­£å¸¸ä½¿ç”¨åœ°å›¾åŠŸèƒ½</p>`;
                    showResult('baiduMapResult', html);
                    log('ç™¾åº¦åœ°å›¾APIåŠ è½½æˆåŠŸ', 'success');
                };
                
                script.onerror = () => {
                    html = `<div class="status error">âŒ ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥</div>`;
                    html += `<p>å¯èƒ½åŸå› :</p>`;
                    html += `<ul>
                        <li>API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ</li>
                        <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                        <li>ç™¾åº¦åœ°å›¾æœåŠ¡ä¸å¯ç”¨</li>
                    </ul>`;
                    showResult('baiduMapResult', html);
                    log('ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥', 'error');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                html = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                showResult('baiduMapResult', html);
            }
        }
        
        async function testHouseDetailPage() {
            log('æµ‹è¯•æˆ¿æºè¯¦æƒ…é¡µåœ°å›¾åŠŸèƒ½...');
            let html = '';
            
            // 1. æ£€æŸ¥æ˜¯å¦æœ‰æˆ¿æº
            const housesResult = await fetchAPI('/api/houses?limit=1');
            if (!housesResult.success || !housesResult.data?.success || !housesResult.data.data?.length) {
                html = `<div class="status error">âŒ æ²¡æœ‰æˆ¿æºæ•°æ®ï¼Œæ— æ³•æµ‹è¯•</div>`;
                html += `<p>è¯·å…ˆå¯¼å…¥æˆ¿æºæ•°æ®</p>`;
                showResult('baiduMapResult', html);
                return;
            }
            
            const firstHouse = housesResult.data.data[0];
            html = `<div class="status success">âœ… æ‰¾åˆ°æµ‹è¯•æˆ¿æº</div>`;
            html += `<p><strong>æˆ¿æºID:</strong> ${firstHouse.ID}</p>`;
            html += `<p><strong>æ ‡é¢˜:</strong> ${firstHouse.houseTitle}</p>`;
            html += `<p><strong>å°åŒº:</strong> ${firstHouse.communityName}</p>`;
            
            // 2. æ£€æŸ¥åœ°å›¾é…ç½®
            const configResult = await fetchAPI('/api/config');
            if (!configResult.success || !configResult.data?.success) {
                html += `<div class="status error">âŒ åœ°å›¾é…ç½®è·å–å¤±è´¥</div>`;
                showResult('baiduMapResult', html);
                return;
            }
            
            const apiKey = configResult.data.data?.baidu_map?.api_key;
            html += `<div class="status success">âœ… åœ°å›¾é…ç½®æ­£å¸¸</div>`;
            html += `<p><strong>API Key:</strong> ${apiKey ? apiKey.substring(0, 10) + '...' : 'æœªé…ç½®'}</p>`;
            
            // 3. æ‰“å¼€æˆ¿æºè¯¦æƒ…é¡µ
            html += `<div class="status pending">ğŸ“ å¯ä»¥æµ‹è¯•æˆ¿æºè¯¦æƒ…é¡µäº†</div>`;
            html += `<p><a href="/house-detail.html?id=${firstHouse.ID}" target="_blank" style="color:#667eea;font-weight:600;">
                ç‚¹å‡»è¿™é‡Œæ‰“å¼€æˆ¿æºè¯¦æƒ…é¡µ â†’
            </a></p>`;
            html += `<p style="margin-top:1rem;"><strong>è°ƒè¯•æ­¥éª¤:</strong></p>`;
            html += `<ol style="margin-left:2rem;">
                <li>ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æ‰“å¼€æˆ¿æºè¯¦æƒ…é¡µ</li>
                <li>æŒ‰F12æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·</li>
                <li>æŸ¥çœ‹Consoleæ ‡ç­¾é¡µçš„æ—¥å¿—è¾“å‡º</li>
                <li>æ£€æŸ¥æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
                    <ul>
                        <li>"è·å–ç™¾åº¦åœ°å›¾é…ç½®..."</li>
                        <li>"å¼€å§‹åŠ è½½ç™¾åº¦åœ°å›¾è„šæœ¬..."</li>
                        <li>"ç™¾åº¦åœ°å›¾åŠ è½½æˆåŠŸ"</li>
                        <li>"initMap è¢«è°ƒç”¨ï¼Œåœ°å€: xxx"</li>
                    </ul>
                </li>
                <li>æŸ¥çœ‹åœ°å›¾æ˜¯å¦æ­£å¸¸æ˜¾ç¤º</li>
            </ol>`;
            
            showResult('baiduMapResult', html);
            log('æˆ¿æºè¯¦æƒ…é¡µæµ‹è¯•ä¿¡æ¯å·²ç”Ÿæˆ', 'success');
        }
        
        async function runFullDiagnosis() {
            log('å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            let report = [];
            
            // 1. æ£€æŸ¥æˆ¿æºåˆ—è¡¨
            report.push('=== 1. æˆ¿æºåˆ—è¡¨æ£€æŸ¥ ===');
            const houses = await fetchAPI('/api/houses?limit=100');
            if (houses.success && houses.data?.success) {
                const count = houses.data.data?.length || 0;
                report.push(`âœ… æˆ¿æºæ€»æ•°: ${count}`);
                if (count === 0) {
                    report.push('âš ï¸ è­¦å‘Š: æ•°æ®åº“ä¸­æ²¡æœ‰æˆ¿æºæ•°æ®ï¼');
                }
            } else {
                report.push('âŒ æˆ¿æºåˆ—è¡¨è·å–å¤±è´¥');
            }
            
            // 2. æ£€æŸ¥çƒ­é—¨æˆ¿æº
            report.push('\n=== 2. çƒ­é—¨æˆ¿æºæ£€æŸ¥ ===');
            const popular = await fetchAPI('/api/houses/popular');
            report.push(`HTTP çŠ¶æ€: ${popular.status}`);
            report.push(`å“åº”å†…å®¹: ${popular.raw?.substring(0, 500) || 'ç©º'}`);
            if (popular.success && popular.data?.success) {
                const count = popular.data.data?.length || 0;
                report.push(`âœ… çƒ­é—¨æˆ¿æºæ•°: ${count}`);
                if (count > 0) {
                    report.push('ç¬¬ä¸€æ¡æ•°æ®:');
                    report.push(JSON.stringify(popular.data.data[0], null, 2));
                }
            } else {
                report.push('âŒ çƒ­é—¨æˆ¿æºè·å–å¤±è´¥');
                report.push('é”™è¯¯ä¿¡æ¯: ' + (popular.data?.message || popular.error || 'æœªçŸ¥'));
            }
            
            // 3. æ£€æŸ¥ç»Ÿè®¡æ•°æ®
            report.push('\n=== 3. ç»Ÿè®¡æ•°æ®æ£€æŸ¥ ===');
            const stats = await fetchAPI('/api/houses/statistics');
            if (stats.success && stats.data?.success) {
                report.push('âœ… ç»Ÿè®¡æ•°æ®æ­£å¸¸');
                report.push(JSON.stringify(stats.data.data, null, 2));
            } else {
                report.push('âŒ ç»Ÿè®¡æ•°æ®è·å–å¤±è´¥');
            }
            
            // 4. æ€»ç»“
            report.push('\n=== è¯Šæ–­æ€»ç»“ ===');
            const housesOk = houses.success && houses.data?.success && (houses.data.data?.length || 0) > 0;
            const popularOk = popular.success && popular.data?.success && (popular.data.data?.length || 0) > 0;
            
            if (!housesOk) {
                report.push('âŒ é—®é¢˜: æ²¡æœ‰æˆ¿æºæ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æˆ¿æº');
            }
            if (housesOk && !popularOk) {
                report.push('âŒ é—®é¢˜: æœ‰æˆ¿æºä½†çƒ­é—¨æˆ¿æºä¸ºç©º');
                report.push('   å¯èƒ½åŸå› :');
                report.push('   1. /api/houses/popular è·¯ç”±æœªæ­£ç¡®åŒ¹é…');
                report.push('   2. getPopularHouses() SQL æŸ¥è¯¢å‡ºé”™');
                report.push('   3. æœåŠ¡å™¨ä»£ç æœªæ›´æ–°');
            }
            if (housesOk && popularOk) {
                report.push('âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼');
            }
            
            log('è¯Šæ–­å®Œæˆ', 'success');
            showResult('diagnosisResult', `<pre>${report.join('\n')}</pre>`);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç®€å•æ£€æŸ¥
        window.onload = function() {
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½');
            log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•å„ä¸ª API');
        };
    </script>
</body>
</html>

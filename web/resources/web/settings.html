<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦æˆ·è®¾ç½® - äºŒæ‰‹æˆ¿ä¿¡æ¯å¹³å°</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>ğŸ  äºŒæ‰‹æˆ¿å¹³å°</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">é¦–é¡µ</a>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="username"></span>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="settings-section">
            <h2>âš™ï¸ è´¦æˆ·è®¾ç½®</h2>
            
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div class="settings-card">
                <h3>åŸºæœ¬ä¿¡æ¯</h3>
                <div class="info-item">
                    <span class="info-label">ç”¨æˆ·åï¼š</span>
                    <span class="info-value" id="displayUsername"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">é‚®ç®±ï¼š</span>
                    <span class="info-value" id="displayEmail"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">è´¦æˆ·ç±»å‹ï¼š</span>
                    <span class="info-value" id="displayRole"></span>
                </div>
            </div>
            
            <!-- ä¿®æ”¹å¯†ç  -->
            <div class="settings-card">
                <h3>ä¿®æ”¹å¯†ç </h3>
                <form id="changePasswordForm">
                    <div class="form-group" id="oldPasswordGroup">
                        <label>å½“å‰å¯†ç </label>
                        <input type="password" name="oldPassword" id="oldPasswordInput" required>
                    </div>
                    
                    <div class="form-group" id="emailVerifyGroup" style="display: none;">
                        <label>é‚®ç®±éªŒè¯ç </label>
                        <div class="input-group">
                            <input type="text" name="code" id="codeInput">
                            <button type="button" class="btn btn-secondary" id="sendCodeBtn">å‘é€éªŒè¯ç </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ–°å¯†ç </label>
                        <input type="password" name="newPassword" id="newPasswordInput" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label>ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" name="confirmPassword" id="confirmPasswordInput" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useEmailVerify">
                            ä½¿ç”¨é‚®ç®±éªŒè¯ï¼ˆæ›´å®‰å…¨ï¼‰
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 äºŒæ‰‹æˆ¿ä¿¡æ¯å¹³å°. All rights reserved.</p>
        </div>
    </footer>

    <style>
        .settings-section {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .settings-section h2 {
            color: #667eea;
            margin-bottom: 2rem;
        }
        
        .settings-card {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .settings-card h3 {
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        
        .info-item {
            display: flex;
            padding: 1rem 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            width: 150px;
        }
        
        .info-value {
            color: #333;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
    </style>

    <script src="/js/common.js"></script>
    <script>
        let sendCodeTimer = null;
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/';
                return;
            }
            
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('displayUsername').textContent = currentUser.username;
            document.getElementById('displayEmail').textContent = currentUser.email || 'æœªç»‘å®š';
            document.getElementById('displayRole').textContent = currentUser.isAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œç¦ç”¨é‚®ç®±éªŒè¯é€‰é¡¹
            if (currentUser.isAdmin) {
                const emailCheckbox = document.getElementById('useEmailVerify');
                const checkboxLabel = emailCheckbox.closest('.checkbox-label');
                emailCheckbox.disabled = true;
                emailCheckbox.checked = false;
                
                // æ·»åŠ ç¦ç”¨æ ·å¼å’Œæç¤º
                checkboxLabel.style.opacity = '0.5';
                checkboxLabel.style.cursor = 'not-allowed';
                checkboxLabel.title = 'ç®¡ç†å‘˜ä¸å…è®¸ä½¿ç”¨é‚®ç®±éªŒè¯ä¿®æ”¹å¯†ç ï¼Œè¯·ä½¿ç”¨æ—§å¯†ç éªŒè¯';
                
                // åœ¨å¤é€‰æ¡†åæ·»åŠ æç¤ºæ–‡æœ¬
                const hint = document.createElement('span');
                hint.style.cssText = 'color: #f44336; font-size: 12px; margin-left: 10px;';
                hint.textContent = '(ç®¡ç†å‘˜ä»…é™ä½¿ç”¨æ—§å¯†ç éªŒè¯)';
                checkboxLabel.appendChild(hint);
            }
        }
        
        // åˆ‡æ¢éªŒè¯æ–¹å¼
        document.getElementById('useEmailVerify').addEventListener('change', function() {
            const useEmail = this.checked;
            const oldPasswordGroup = document.getElementById('oldPasswordGroup');
            const emailVerifyGroup = document.getElementById('emailVerifyGroup');
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const codeInput = document.getElementById('codeInput');
            
            console.log('åˆ‡æ¢éªŒè¯æ–¹å¼:', useEmail ? 'é‚®ç®±éªŒè¯' : 'æ—§å¯†ç éªŒè¯');
            
            if (useEmail) {
                // åˆ‡æ¢åˆ°é‚®ç®±éªŒè¯
                oldPasswordGroup.style.display = 'none';
                emailVerifyGroup.style.display = 'block';
                oldPasswordInput.required = false;
                oldPasswordInput.value = '';
                codeInput.required = true;
            } else {
                // åˆ‡æ¢åˆ°æ—§å¯†ç éªŒè¯
                oldPasswordGroup.style.display = 'block';
                emailVerifyGroup.style.display = 'none';
                oldPasswordInput.required = true;
                codeInput.required = false;
                codeInput.value = '';
            }
        });
        
        // å‘é€éªŒè¯ç 
        document.getElementById('sendCodeBtn').addEventListener('click', async function() {
            if (!currentUser || !currentUser.email) {
                showMessage('æ‚¨çš„è´¦æˆ·æœªç»‘å®šé‚®ç®±', 'error');
                return;
            }
            
            const sendCodeBtn = this;
            sendCodeBtn.disabled = true;
            
            const data = await apiRequest('/api/send-code', {
                method: 'POST',
                body: JSON.stringify({
                    email: currentUser.email,
                    type: 'change_password'
                })
            });
            
            if (data.success) {
                showMessage(data.message, 'success');
                
                // å€’è®¡æ—¶
                let countdown = 60;
                sendCodeBtn.textContent = `${countdown}ç§’åé‡å‘`;
                
                sendCodeTimer = setInterval(() => {
                    countdown--;
                    if (countdown <= 0) {
                        clearInterval(sendCodeTimer);
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
                    } else {
                        sendCodeBtn.textContent = `${countdown}ç§’åé‡å‘`;
                    }
                }, 1000);
            } else {
                showMessage(data.message, 'error');
                sendCodeBtn.disabled = false;
            }
        });
        
        // ä¿®æ”¹å¯†ç 
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('å¯†ç ä¿®æ”¹è¡¨å•æäº¤');
            
            const formData = new FormData(this);
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            const useEmail = document.getElementById('useEmailVerify').checked;
            
            console.log('è¡¨å•æ•°æ®:', {
                newPassword: newPassword ? '***' : '(ç©º)',
                confirmPassword: confirmPassword ? '***' : '(ç©º)',
                useEmail: useEmail
            });
            
            if (newPassword !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            if (!currentUser || !currentUser.userId) {
                showMessage('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                setTimeout(() => {
                    logout();
                }, 1500);
                return;
            }
            
            const requestData = {
                userId: currentUser.userId,
                newPassword: newPassword,
                useEmailVerify: useEmail
            };
            
            if (useEmail) {
                const code = formData.get('code');
                if (!code || code.trim() === '') {
                    showMessage('è¯·è¾“å…¥éªŒè¯ç ', 'error');
                    return;
                }
                requestData.code = code;
                console.log('ä½¿ç”¨é‚®ç®±éªŒè¯ï¼ŒéªŒè¯ç :', code);
            } else {
                const oldPassword = formData.get('oldPassword');
                if (!oldPassword || oldPassword.trim() === '') {
                    showMessage('è¯·è¾“å…¥å½“å‰å¯†ç ', 'error');
                    return;
                }
                requestData.oldPassword = oldPassword;
                console.log('ä½¿ç”¨æ—§å¯†ç éªŒè¯ï¼Œæ—§å¯†ç :', oldPassword ? '***' : '(ç©º)');
            }
            
            console.log('å‘é€å¯†ç ä¿®æ”¹è¯·æ±‚:', requestData);
            
            try {
                const data = await apiRequest('/api/change-password', {
                    method: 'POST',
                    body: JSON.stringify(requestData)
                });
                
                console.log('æœåŠ¡å™¨å“åº”:', data);
                
                if (data && data.success) {
                    showMessage('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('changePasswordForm').reset();
                    setTimeout(() => {
                        logout();
                    }, 2000);
                } else {
                    const errorMsg = data && data.message ? data.message : 'å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•';
                    console.error('å¯†ç ä¿®æ”¹å¤±è´¥:', errorMsg);
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç è¯·æ±‚å¤±è´¥:', error);
                showMessage('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿ common.js å·²ç»åŠ è½½å®Œ localStorage
            setTimeout(() => {
                loadUserInfo();
            }, 100);
        });
    </script>
</body>
</html>
